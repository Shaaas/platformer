<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Super Platformer Pro: Kinetic Edition</title>
<style>
  body { margin: 0; overflow: hidden; background: #222; font-family: 'Segoe UI', sans-serif; }
  canvas { display: block; margin: 0 auto; background: #87ceeb; border: 4px solid #333; }
  #ui-layer {
    position: absolute; top: 10px; left: 10px; color: white; text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
    pointer-events: none; width: 100%;
  }
  #restartBtn {
    position: absolute; top: 60%; left: 50%; transform: translate(-50%, -50%);
    padding: 15px 30px; font-size: 24px; display: none; cursor: pointer;
    background: #ff4757; color: white; border: none; border-radius: 8px; font-weight: bold;
  }
</style>
</head>
<body>
<div id="ui-layer">
  <div style="font-size: 24px;">Score: <span id="scoreVal">0</span></div>
  <div style="font-size: 18px;">Level: <span id="lvlVal">1</span></div>
</div>
<canvas id="gameCanvas" width="800" height="400"></canvas>
<button id="restartBtn">RETRY</button>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const restartBtn = document.getElementById('restartBtn');
const scoreVal = document.getElementById('scoreVal');
const lvlVal = document.getElementById('lvlVal');

// --- GAME STATE ---
let score = 0;
let gameOver = false;
let currentLevel = 0;
let particles = [];
let shakeRemaining = 0; // Screen shake timer

const player = {
  x:50, y:300, width:30, height:40, 
  dx:0, dy:0, speed:6, jumpPower:11, 
  onGround:false, jumpsLeft: 2
};

// --- ASSETS ---
const assets = { player: new Image(), platform: new Image(), coin: new Image(), enemy: new Image() };
assets.player.src = 'player.png';
assets.platform.src = 'platform.png';
assets.coin.src = 'coin.png';
assets.enemy.src = 'enemy.png';

// --- LEVEL DATA ---
const levels = [
  {
    platforms: [
        {x:0, y:350, w:800, h:50, type:'static'},
        {x:300, y:250, w:150, h:20, type:'moving', range:150, speed:2, vertical:false, startX:300, startY:250},
        {x:550, y:180, w:120, h:20, type:'static'}
    ],
    collectibles: [{x:350,y:210,w:25,h:25,active:true}],
    enemies: [{x:400,y:320,w:30,h:30,dx:2,L:100,R:700}],
    endX: 750
  }
];

let state = { platforms: [], collectibles: [], enemies: [] };

function loadLevel(idx) {
  const level = levels[idx] || levels[0];
  state.platforms = JSON.parse(JSON.stringify(level.platforms));
  state.collectibles = JSON.parse(JSON.stringify(level.collectibles));
  state.enemies = JSON.parse(JSON.stringify(level.enemies));
  player.x = 50; player.y = 300; player.dx = 0; player.dy = 0;
  player.jumpsLeft = 2;
  gameOver = false;
  restartBtn.style.display = 'none';
  lvlVal.innerText = idx + 1;
}

// --- INPUTS ---
const keys = {};
window.addEventListener('keydown', e => {
  if (e.code === 'ArrowUp' || e.code === 'KeyW' || e.code === 'Space') {
    if (player.jumpsLeft > 0) {
      player.dy = -player.jumpPower;
      player.jumpsLeft--;
      player.onGround = false;
    }
  }
  keys[e.code] = true;
});
window.addEventListener('keyup', e => keys[e.code] = false);

function createParticles(x, y, color) {
  for(let i=0; i<10; i++) {
    particles.push({
      x, y, dx: (Math.random()-0.5)*8, dy: (Math.random()-0.5)*8, 
      life: 25, color: color, size: Math.random()*5
    });
  }
}

function update() {
  if(gameOver) return;

  // Horizontal Movement
  if(keys['ArrowRight'] || keys['KeyD']) player.dx = 6;
  else if(keys['ArrowLeft'] || keys['KeyA']) player.dx = -6;
  else player.dx *= 0.8;

  player.dy += 0.6; // gravity
  player.x += player.dx;
  player.y += player.dy;

  // Platform Logic
  player.onGround = false;
  state.platforms.forEach(p => {
    // Move platforms
    if(p.type === 'moving') {
        p.startX += p.speed;
        if(p.startX > p.range + p.x || p.startX < p.x - p.range) p.speed *= -1;
        p.x = p.startX; 
    }

    // Collision
    if(player.x < p.x + p.w && player.x + player.width > p.x &&
       player.y + player.height > p.y && player.y + player.height < p.y + p.h + player.dy) {
      player.y = p.y - player.height;
      player.dy = 0;
      player.onGround = true;
      player.jumpsLeft = 2;
      
      // Carry player with moving platform
      if(p.type === 'moving') player.x += p.speed;
    }
  });

  // Enemy Mechanics
  state.enemies.forEach((e, i) => {
    e.x += e.dx;
    if(e.x < e.L || e.x + e.w > e.R) e.dx *= -1;

    if(player.x < e.x + e.w && player.x + player.width > e.x && player.y < e.y + e.h && player.y + player.height > e.y) {
      if(player.dy > 0 && player.y + player.height < e.y + e.h/2) {
        state.enemies.splice(i, 1);
        player.dy = -10;
        player.jumpsLeft = 1;
        score += 50;
        scoreVal.innerText = score;
        shakeRemaining = 10; // Trigger Shake
        createParticles(e.x, e.y, '#ff4757');
      } else {
        gameOver = true;
        shakeRemaining = 20;
        restartBtn.style.display = 'block';
      }
    }
  });

  // Screen Shake decrement
  if(shakeRemaining > 0) shakeRemaining--;

  // Particle life
  particles.forEach((p, i) => {
    p.x += p.dx; p.y += p.dy; p.life--;
    if(p.life <= 0) particles.splice(i, 1);
  });

  // Screen Bounds
  if(player.x < 0) player.x = 0;
  if(player.y > canvas.height) { gameOver = true; restartBtn.style.display = 'block'; }
}

function draw() {
  ctx.save();
  
  // Apply Screen Shake
  if (shakeRemaining > 0) {
    let shakeX = (Math.random() - 0.5) * 7;
    let shakeY = (Math.random() - 0.5) * 7;
    ctx.translate(shakeX, shakeY);
  }

  // Clear Sky
  ctx.fillStyle = '#87ceeb';
  ctx.fillRect(0,0,canvas.width,canvas.height);

  // Draw Platforms
  state.platforms.forEach(p => {
    ctx.fillStyle = p.type === 'moving' ? '#57606f' : '#2ed573';
    ctx.fillRect(p.x, p.y, p.w, p.h);
  });

  // Draw Particles
  particles.forEach(p => {
    ctx.fillStyle = p.color;
    ctx.fillRect(p.x, p.y, p.size, p.size);
  });

  // Draw Player
  ctx.fillStyle = 'white';
  ctx.fillRect(player.x, player.y, player.width, player.height);

  // Draw Enemies
  state.enemies.forEach(e => {
    ctx.fillStyle = '#ff4757';
    ctx.fillRect(e.x, e.y, e.w, e.h);
  });

  ctx.restore(); // Stop shaking for UI

  if(gameOver) {
    ctx.fillStyle = 'rgba(0,0,0,0.7)';
    ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle = 'white';
    ctx.font = 'bold 48px Arial';
    ctx.textAlign = 'center';
    ctx.fillText('CRASHED!', canvas.width/2, 200);
  }
}

restartBtn.addEventListener('click', () => loadLevel(currentLevel));

function loop() {
  update();
  draw();
  requestAnimationFrame(loop);
}

loadLevel(0);
loop();
</script>
</body>
</html>
