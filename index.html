<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Super Sprites: Lava & Level Fixes</title>
<style>
  body { margin: 0; overflow: hidden; background: #1a1a1a; font-family: 'Segoe UI', sans-serif; }
  canvas { display: block; margin: 0 auto; background: #87ceeb; border: 4px solid #444; }
  #ui-layer {
    position: absolute; top: 15px; left: 15px; color: white; text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
    pointer-events: none; width: 100%;
  }
  #restartBtn {
    position: absolute; top: 60%; left: 50%; transform: translate(-50%, -50%);
    padding: 15px 30px; font-size: 24px; display: none; cursor: pointer;
    background: #ff4757; color: white; border: none; border-radius: 8px; font-weight: bold;
  }
</style>
</head>
<body>
<div id="ui-layer">
  <div style="font-size: 26px; font-weight: bold;">Score: <span id="scoreVal">0</span></div>
  <div style="font-size: 18px; color: #ffd700;">Level: <span id="lvlVal">1</span></div>
  <div style="font-size: 12px; opacity: 0.8;">SHIFT to Dash | Space to Double Jump</div>
</div>
<canvas id="gameCanvas" width="800" height="400"></canvas>
<button id="restartBtn">RETRY LEVEL</button>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const restartBtn = document.getElementById('restartBtn');
const scoreVal = document.getElementById('scoreVal');
const lvlVal = document.getElementById('lvlVal');

const assets = { player: new Image(), platform: new Image(), coin: new Image(), enemy: new Image() };
assets.player.src = 'player.png';
assets.platform.src = 'platform.png';
assets.coin.src = 'coin.png';
assets.enemy.src = 'enemy.png';

let score = 0;
let gameOver = false;
let currentLevel = 0;
let particles = [];
let shakeRemaining = 0;
let ghosts = [];

const player = {
  x:50, y:100, width:40, height:50,
  dx:0, dy:0, speed:6, jumpPower:12, 
  onGround:false, jumpsLeft: 2,
  dashCooldown: 0, isDashing: 0, facing: 1
};

const levels = [
  { // Level 1
    platforms: [
        {x:0, y:350, w:800, h:50, type:'static'},
        {x:200, y:250, w:150, h:20, type:'static'},
        {x:450, y:180, w:150, h:20, type:'static'}
    ],
    collectibles: [{x:250, y:210, w:30, h:30, active:true}],
    enemies: [{x:400, y:315, w:35, h:35, dx:2, L:300, R:700}],
    endX: 750
  },
  { // Level 2: FIXED MOVING PLATFORMS
    platforms: [
        {x:0, y:350, w:200, h:50, type:'static'},
        {x:300, y:280, w:120, h:20, type:'moving', range:100, speed:2, basePos: 300},
        {x:550, y:200, w:120, h:20, type:'moving', range:80, speed:-2, basePos: 550},
        {x:700, y:350, w:100, h:50, type:'static'}
    ],
    collectibles: [{x:350, y:120, w:30, h:30, active:true}],
    enemies: [{x:50, y:315, w:35, h:35, dx:1, L:10, R:180}],
    endX: 750
  },
  { // Level 3: The Gauntlet
    platforms: [
        {x:0, y:350, w:150, h:50, type:'static'},
        {x:200, y:280, w:80, h:20, type:'static'},
        {x:400, y:280, w:80, h:20, type:'moving', range:100, speed:3, basePos: 400},
        {x:650, y:220, w:150, h:20, type:'static'}
    ],
    collectibles: [{x:450, y:150, w:30, h:30, active:true}],
    enemies: [{x:650, y:185, w:35, h:35, dx:3, L:650, R:780}],
    endX: 750
  }
];

let state = { platforms: [], collectibles: [], enemies: [] };

function loadLevel(idx) {
  if (idx >= levels.length) {
    alert("YOU WIN! SCORE: " + score);
    currentLevel = 0; score = 0; idx = 0;
  }
  const level = levels[idx];
  state.platforms = JSON.parse(JSON.stringify(level.platforms));
  state.collectibles = JSON.parse(JSON.stringify(level.collectibles));
  state.enemies = JSON.parse(JSON.stringify(level.enemies));
  player.x = 50; player.y = 100;
  player.dx = 0; player.dy = 0;
  player.jumpsLeft = 2;
  player.dashCooldown = 0;
  gameOver = false;
  restartBtn.style.display = 'none';
  lvlVal.innerText = idx + 1;
}

const keys = {};
window.addEventListener('keydown', e => {
  if (!gameOver) {
    if ((e.code === 'ArrowUp' || e.code === 'KeyW' || e.code === 'Space') && player.jumpsLeft > 0) {
        player.dy = -player.jumpPower;
        player.jumpsLeft--; player.onGround = false;
        createParticles(player.x + player.width/2, player.y + player.height, 'white');
    }
    if ((e.code === 'ShiftLeft' || e.code === 'ShiftRight') && player.dashCooldown <= 0) {
        player.isDashing = 12; player.dashCooldown = 45; shakeRemaining = 5;
    }
  }
  keys[e.code] = true;
});
window.addEventListener('keyup', e => keys[e.code] = false);

function createParticles(x, y, color) {
  for(let i=0; i<8; i++) {
    particles.push({x, y, dx: (Math.random()-0.5)*10, dy: (Math.random()-0.5)*10, life: 15, color: color, size: Math.random()*5});
  }
}

function update() {
  if(gameOver) return;

  if(keys['ArrowRight'] || keys['KeyD']) { player.dx = 6; player.facing = 1; }
  else if(keys['ArrowLeft'] || keys['KeyA']) { player.dx = -6; player.facing = -1; }
  else player.dx *= 0.8;

  if (player.isDashing > 0) {
    player.dx = player.facing * 16; player.dy = 0; player.isDashing--;
    if(player.isDashing % 2 === 0) ghosts.push({x: player.x, y: player.y, life: 20});
  } else { player.dy += 0.6; }
  if (player.dashCooldown > 0) player.dashCooldown--;

  player.x += player.dx;
  player.y += player.dy;

  // Moving Platform Fix: Calculate movement from a fixed basePos
  player.onGround = false;
  state.platforms.forEach(p => {
    if(p.type === 'moving') {
        let offset = Math.sin(Date.now() / 500) * p.range; // Smooth sine wave movement
        let oldX = p.x;
        p.x = p.basePos + offset;
        let pSpeed = p.x - oldX;
        if(player.x < p.x + p.w && player.x + player.width > p.x &&
           player.y + player.height > p.y && player.y + player.height < p.y + p.h + player.dy) {
            player.y = p.y - player.height; player.dy = 0; player.onGround = true; player.jumpsLeft = 2;
            player.x += pSpeed; // Move player with platform
        }
    } else {
        if(player.x < p.x + p.w && player.x + player.width > p.x &&
           player.y + player.height > p.y && player.y + player.height < p.y + p.h + player.dy) {
            player.y = p.y - player.height; player.dy = 0; player.onGround = true; player.jumpsLeft = 2;
        }
    }
  });

  state.collectibles.forEach(c => {
    if(c.active && player.x < c.x + c.w && player.x + player.width > c.x && player.y < c.y + c.h && player.y + player.height > c.y) {
      c.active = false; score += 100; scoreVal.innerText = score;
      createParticles(c.x + c.w/2, c.y + c.h/2, 'gold');
    }
  });

  state.enemies.forEach((e, i) => {
    e.x += e.dx; if(e.x < e.L || e.x + e.w > e.R) e.dx *= -1;
    if(player.x < e.x + e.w && player.x + player.width > e.x && player.y < e.y + e.h && player.y + player.height > e.y) {
      if(player.dy > 0 && player.y + player.height < e.y + e.h/2) {
        state.enemies.splice(i, 1); player.dy = -10; player.jumpsLeft = 1; score += 250;
        scoreVal.innerText = score; shakeRemaining = 10;
      } else { gameOver = true; restartBtn.style.display = 'block'; }
    }
  });

  if(player.x >= 750) { currentLevel++; loadLevel(currentLevel); }
  if(player.x < 0) player.x = 0;
  if(player.y > canvas.height - 20) { gameOver = true; shakeRemaining = 20; restartBtn.style.display = 'block'; }
  
  if(shakeRemaining > 0) shakeRemaining--;
  particles.forEach((p, i) => { p.x += p.dx; p.y += p.dy; p.life--; if(p.life <= 0) particles.splice(i, 1); });
  ghosts.forEach((g, i) => { g.life--; if(g.life <= 0) ghosts.splice(i, 1); });
}

function draw() {
  ctx.save();
  if (shakeRemaining > 0) ctx.translate((Math.random()-0.5)*7, (Math.random()-0.5)*7);
  ctx.fillStyle = '#87ceeb'; ctx.fillRect(0,0,canvas.width,canvas.height);

  // Draw Lava at the bottom
  ctx.fillStyle = '#ff4500';
  ctx.fillRect(0, canvas.height - 20, canvas.width, 20);
  for(let i=0; i<canvas.width; i+=40) { // Animated Lava "bubbles"
    ctx.beginPath();
    ctx.arc(i + Math.sin(Date.now()/500)*10, canvas.height-20, 15, 0, Math.PI, true);
    ctx.fill();
  }

  ghosts.forEach(g => { ctx.globalAlpha = g.life / 40; ctx.drawImage(assets.player, g.x, g.y, player.width, player.height); });
  ctx.globalAlpha = 1.0;
  state.platforms.forEach(p => ctx.drawImage(assets.platform, p.x, p.y, p.w, p.h));
  state.collectibles.forEach(c => { if(c.active) ctx.drawImage(assets.coin, c.x, c.y, c.w, c.h); });
  state.enemies.forEach(e => ctx.drawImage(assets.enemy, e.x, e.y, e.w, e.h));
  particles.forEach(p => { ctx.fillStyle = p.color; ctx.fillRect(p.x, p.y, p.size, p.size); });
  ctx.drawImage(assets.player, player.x, player.y, player.width, player.height);
  ctx.restore();

  if(gameOver) {
    ctx.fillStyle = 'rgba(0,0,0,0.7)'; ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle = 'white'; ctx.font = 'bold 48px Arial'; ctx.textAlign = 'center';
    ctx.fillText('CRITICAL FAILURE', canvas.width/2, 200);
  }
}

restartBtn.addEventListener('click', () => loadLevel(currentLevel));
function loop() { update(); draw(); requestAnimationFrame(loop); }
loadLevel(0);
loop();
</script>
</body>
</html>
